<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sigma Viewer</title>
    <style>
      html, body { height: 100%; margin: 0; }
      #container { position: absolute; inset: 0; }
      #overlay {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: rgba(255,255,255,0.92);
        border: 1px solid rgba(0,0,0,0.08);
        border-radius: 8px;
        padding: 8px 10px;
        font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        color: #111;
      }
      #overlay code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
  </head>
  <body>
    <div id="container"></div>
    <div id="overlay">Cargando visor…</div>

    <!-- Sigma v1 (simple y robusto) -->
    <script src="https://unpkg.com/sigma@1.2.1/build/sigma.min.js"></script>

    <script>
      (function () {
        const overlay = document.getElementById("overlay");
        const container = document.getElementById("container");

        let s = null;
        let maxNodes = 100;

        function clamp(n, a, b) {
          return Math.max(a, Math.min(b, n));
        }

        function normalizeGraphData(g) {
          g = g || {};
          let nodes = Array.isArray(g.nodes) ? g.nodes.slice() : [];
          let edges = Array.isArray(g.edges) ? g.edges.slice() : [];

          if (nodes.length > maxNodes) {
            nodes = nodes.slice(0, maxNodes);
            const allowed = new Set(nodes.map((n) => n.id));
            edges = edges.filter((e) => allowed.has(e.source) && allowed.has(e.target));
          }

          const N = nodes.length || 1;
          for (let i = 0; i < nodes.length; i++) {
            const n = nodes[i] || {};
            const angle = (2 * Math.PI * i) / N;

            if (typeof n.x !== "number") n.x = Math.cos(angle);
            if (typeof n.y !== "number") n.y = Math.sin(angle);
            if (typeof n.size !== "number") n.size = 1.5;

            if (!n.label) n.label = String(n.id || "");
            if (!n.color) n.color = "#909090";

            nodes[i] = n;
          }

          for (let j = 0; j < edges.length; j++) {
            const e = edges[j] || {};
            if (!e.id) e.id = `${e.source}__${e.target}__${j}`;
            if (!e.type) e.type = "line";
            if (!e.color) e.color = "#c9c9c9";
            edges[j] = e;
          }

          return { nodes, edges };
        }

        function renderGraph(graphData) {
          const graph = normalizeGraphData(graphData);

          if (!graph.nodes.length) {
            overlay.innerHTML = "No hay nodos que mostrar. (graphData vacío)";
            if (s) {
              s.graph.clear();
              s.refresh();
            }
            return;
          }

          overlay.innerHTML =
            `Nodos: <code>${graph.nodes.length}</code> · Aristas: <code>${graph.edges.length}</code> · ` +
            `Doble click en un nodo para expandir 1 nivel.`;

          if (!s) {
            s = new sigma({
              graph,
              container,
              settings: {
                labelThreshold: 6,
                minNodeSize: 1,
                maxNodeSize: 10,
                defaultNodeColor: "#888",
                zoomingRatio: 1.5,
                doubleClickEnabled: true,
              },
            });

            s.bind("doubleClickNode", function (e) {
              const node = e && e.data && e.data.node;
              if (!node || !node.id) return;
              window.parent && window.parent.postMessage({ type: "expandNode", node_id: node.id }, "*");
            });
          } else {
            s.graph.clear();
            s.graph.read(graph);
            s.refresh();
          }
        }

        window.addEventListener("message", function (evt) {
          const data = evt.data || {};
          if (data.type === "setMaxNodes") {
            const v = parseInt(data.maxNodes, 10);
            if (!isNaN(v)) maxNodes = clamp(v, 10, 500);
          }
          if (data.type === "graphData") {
            renderGraph(data.graphData);
          }
        });

        // handshake
        try {
          window.parent && window.parent.postMessage({ type: "sigmaReady" }, "*");
        } catch (e) {}

        overlay.textContent = "Esperando graphData…";
      })();
    </script>
  </body>
</html>
